#!/bin/bash
# AI Development CLI - 256GB Optimized (Multi-Invocation)

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
STAGES_DIR="$SCRIPT_DIR/../stages"
LIB_DIR="$SCRIPT_DIR/../lib"

source "$LIB_DIR/common.sh"
source "$LIB_DIR/models.sh"

show_help() {
    cat <<HELP
AI Development CLI (256GB Optimized - Multi-Invocation)

Commands:
  ./ai-dev init              - Check system readiness
  ./ai-dev plan              - Run Stage 1: Create plan from spec
  ./ai-dev build             - Run Stage 2: Build files from plan
  ./ai-dev review            - Run Stage 3: Review implementation
  ./ai-dev fix               - Run Stage 4: Apply fixes (if needed)
  ./ai-dev full              - Run all stages (plan → build → review → fix)
  ./ai-dev status            - Check model server status
  ./ai-dev demo              - Run demo project

Stages:
  1. Plan:    Spec → plan.json (Builder, fresh context)
  2. Build:   plan.json → files (Builder, fresh per file)
  3. Review:  files → review.json (Reviewer, fresh context)
  4. Fix:     review.json → fixed files (Builder, if needed)

Documentation:
  See Agents.md and ARCHITECTURE.md for details.

HELP
}

case "$1" in
    init)
        log "Initializing AI development environment..."
        echo ""
        if check_all_models; then
            echo ""
            success "All systems ready"
            echo ""
            echo "Next steps:"
            echo "  ./ai-dev plan    - Create plan from spec"
            echo "  ./ai-dev full    - Run complete pipeline"
        else
            echo ""
            error "Some model servers are offline"
            echo "Start with: ./start.sh"
            exit 1
        fi
        ;;

    plan|01)
        "$STAGES_DIR/01-plan.sh"
        ;;

    build|02)
        "$STAGES_DIR/02-build.sh"
        ;;

    review|03)
        "$STAGES_DIR/03-review.sh"
        ;;

    fix|04)
        "$STAGES_DIR/04-fix.sh"
        ;;

    full)
        log "Running full pipeline..."
        echo ""

        # Stage 1: Plan
        if ! "$STAGES_DIR/01-plan.sh"; then
            error "Stage 1 (Plan) failed"
            exit 1
        fi

        # Check if no pending features
        if jq -e '.status == "NO_PENDING_FEATURES"' plan.json > /dev/null 2>&1; then
            log "No pending features. Done."
            exit 0
        fi

        echo ""

        # Stage 2: Build
        if ! "$STAGES_DIR/02-build.sh"; then
            error "Stage 2 (Build) failed"
            exit 1
        fi

        echo ""

        # Stage 3: Review
        if ! "$STAGES_DIR/03-review.sh"; then
            warn "Stage 3 (Review) had issues, continuing..."
        fi

        echo ""

        # Stage 4: Fix (conditional)
        if [ -f review.json ]; then
            ISSUE_COUNT=$(jq '.issues | length' review.json 2>/dev/null || echo 0)
            if [ "$ISSUE_COUNT" -gt 0 ]; then
                log "Found $ISSUE_COUNT issues, attempting fix..."
                "$STAGES_DIR/04-fix.sh" || warn "Fix stage had issues"
            fi
        fi

        echo ""
        success "Full pipeline complete!"
        echo ""
        echo "Next:"
        echo "  - Run tests: npm test"
        echo "  - Review changes: git diff"
        ;;

    status)
        check_all_models
        ;;

    demo)
        log "Running demo..."
        "$SCRIPT_DIR/../demo.sh"
        ;;

    *)
        show_help
        ;;
esac
